# Finance Bot (RUB, Europe/Moscow)

Телеграм-бот учёта доходов/расходов с хранением в PostgreSQL. Поддерживает выбор каналов, сумму с копейками, ссылку на чек и комментарий, а также дедупликацию операций.

## Возможности
- Доходы/расходы по категориям и каналам (мультивыбор каналов)
- Сумма с копейками: `1200.50`, `1 200,50`, `1200,5`
- Необязательные поля: ссылка на чек (URL) и комментарий
- Дедупликация по окну 3 минуты (см. ниже)
- Вайтлист пользователей (работает только в личке)
- Логи только в консоль (stdout)

## Команды бота
- `/start` — стартовое сообщение и подсказки
- `/help` — краткая справка
- `/add` — добавление операции пошагово
- `/in` — быстрый старт добавления дохода (сразу выбор категории)
- `/out` — быстрый старт добавления расхода (сразу выбор категории)
- `/cancel` — отмена текущей операции

## Логика дедупликации
Для защиты от повторных подтверждений вычисляется `dedup_hash` (SHA-256) из полей:
- `tg_user_id`, `op_type`, `category_code`, `amount_kop`, отсортированные уникальные `channel_ids`, `is_general`, и время, округлённое к началу текущего 3‑минутного окна.

Если в течение 3 минут поступят повторные подтверждения с тем же набором полей — сработает уникальный ключ, новая запись не создастся, пользователь увидит сообщение про дубликат.

## Переменные окружения
- `BOT_TOKEN` — токен бота
- `DB_HOST`, `DB_PORT`, `DB_NAME`, `DB_USER`, `DB_PASSWORD` — параметры PostgreSQL
- `WHITELIST_USER_IDS` — список user_id через запятую (доступ только из этого списка)
- `TZ` — часовой пояс, по умолчанию `Europe/Moscow`
- `LOG_LEVEL` — уровень логирования, по умолчанию `INFO`

## Установка и запуск локально
```
python -m venv .venv
source .venv/bin/activate
pip install -U pip
pip install -e .
export BOT_TOKEN=***
export DB_HOST=host
export DB_PORT=5432
export DB_NAME=db
export DB_USER=user
export DB_PASSWORD=pass
export WHITELIST_USER_IDS="12345,67890"
export TZ=Europe/Moscow

# Миграции применяются автоматически при старте приложения.
# При желании можно выполнить вручную:
alembic upgrade head

PYTHONPATH=src python -m bot.main
```

Также можно воспользоваться Makefile:
```
make venv
make run
```

## Docker
Сборка образа:
```
docker build -t finance-bot:latest .
```
Запуск:
```
docker run --rm \
  -e BOT_TOKEN=*** \
  -e DB_HOST=host \
  -e DB_PORT=5432 \
  -e DB_NAME=db \
  -e DB_USER=user \
  -e DB_PASSWORD=pass \
  -e WHITELIST_USER_IDS="12345,67890" \
  -e TZ=Europe/Moscow \
  finance-bot:latest
```

## Примечания
- Бот работает только в приватных чатах (Whitelist middleware).
- После шага выбора каналов — мультивыбор, выбранные помечаются галочкой, в сообщении показан список выбранных.
- В подтверждении выводится: тип, категория (по‑русски), сумма, каналы, а также чек/комментарий при наличии.